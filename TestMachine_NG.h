! Licencia de Uso
!-----------------------------------------------------------------------------------------------------------------------
!
!Esta obra se encuentra protegida por la licencia Creative Commons Reconocimiento-No comercial-Sin obras derivadas 3.0 España. La ubicación original de la licencia puede !encontrarse en:
!http://creativecommons.org/licenses/by-nc-nd/3.0/es/. 
! Y se resume en los siguientes puntos:
!
!Usted es libre de:
!
!* Copiar, distribuir y comunicar públicamente la obra.
!
!Bajo las condiciones siguientes:
!* Reconocimiento. Debe reconocer los créditos de la obra de la manera especificada por el autor o el licenciador (pero no de una manera que sugiera que tiene su apoyo o apoyan !el uso que hace de su obra).
!* No comercial. No puede utilizar esta obra para fines comerciales.
!* Sin obras derivadas. No se puede alterar, transformar o generar una obra derivada a partir de esta obra.
!* Al reutilizar o distribuir la obra, tiene que dejar bien claro los términos de la licencia de esta obra.
!* Alguna de estas condiciones puede no aplicarse si se obtiene el permiso del titular de los derechos de autor.
!* Nada en esta licencia menoscaba o restringe los derechos morales del autor.
!--------------------------------------------------------------------------------------

! Versión para INFSP6 por Ricardo Pérez (Sothoth) - Alpha Aventuras, 2012
! Modificaciones siguientes:
! - Modificada para que la rutina hackeada sea KeyboardPrimitive en lugar de
!   Parser__parse. KeyboardPrimitive es mucho más corta y sencilla que
!   Parser__parse, y además ahora ya no hace falta hackear la librería gtalk.h
! - Modificada para incluir un hackeo de KeyCharPrimitive, por si se usara esa
!   rutina en lugar de KeyboardPrimitive
! - Modificada para permitir la ejecución "paso a paso" del test (run_once)
!
! Sistema automático de testeo para inform
! Añadir Replace KeyboardPrimitive;
! 19 de Marzo de 2011
! Usar como herramienta para genera las secuencias de test: genera_test_vector.py
Global parse_input_externo = 0;
!Array input_buffer_aux   -> 121;            ! Buffer for injecting commands 

! Cada mensaje puede alojar hasta   
Array input_array -->
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
! 10
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!20
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!30
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!40
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!50
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!60
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!70
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!80
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!90
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!100
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
! 110
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!120
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!30
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!40
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!150
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!160
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!70
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!80
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!190
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!200
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
! 210
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!20
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!230
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!40
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!250
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!60
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!70
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!280
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!290
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
"1234567890123456789012345678901234567890"
!300
;

Constant MAX_COMANDOS = 300;

Object test_machine
  with
!    estado 0,
!    capitulo 0,
    posicion 0, ! Puntero de pila
    is_empty [;
      if (self.posicion == 0) rtrue;
      rfalse;
    ],
    inserta [ comando;
      if (self.posicion < MAX_COMANDOS) {               
        input_array-->self.posicion = comando;  ! Copia el comando al array 
        self.posicion++;
      } else "(ERROR) No hay memoria libre para comandos.";
    ],
    borra [ num_comando      ! Borra
      i;
      ! Compacta las pilas
      i = num_comando;
      while (i < (self.posicion - 1)) {
        input_array-->i = input_array-->(i + 1);
        i++;    
      }
      self.posicion--;
    ],
    clear [;     ! Resetea el array de comandos...  
      self.posicion = 0;
    ],
    run [;  ! Extrae los comandos de la cola y los inyecta como si fueran
            ! el input del jugador
      parse_input_externo = 1;
    ],
    run_once [; ! Ejecuta un único comando de la cola (c) Alpha
      parse_input_externo = 2;                      ! (c) Alpha
    ],                                              ! (c) Alpha
    get_input [   ! Extrae el comando actual
      puntero longitud;
      if (self.posicion == 0) {    
        parse_input_externo = 0; ! Si no quedan comandos devuelve el control
        rfalse; ! No hay comandos disponibles
      }
      ! Puntero al buffer...
      puntero = input_array-->0; ! Array de cadenas de texto, FIRST IN, FIRST OUT
      glk($0086, 8);
      print "# ", (string) puntero, "^";
      glk($0086, 0);
      longitud = PrintAnyToArray(buffer + WORDSIZE, INPUT_BUFFER_LEN, puntero);  
      buffer-->0 = longitud;    
      ! Borra el comando actual
      self.borra(0); ! Se extraen desde abajo de la pila. FIRST IN FIRST OUT  
      rtrue;
    ];
!    Ruta [ locdestino actor i; ! Genera un paso a partir de PNJMOVIL...
!      ! Por defecto usa el Jugador actual. 
!      actor = player;
!      if (PNJ_Ruta(actor, MOVIMIENTO_POR_META, locdestino)) {
!        ! Si ha encontrado ruta...
!        i = actor.&pnj_dirs-->0;  ! El primer paso...
!        if (i == n_obj)        self.inserta("n");
!        else if (i == s_obj)   self.inserta("s");
!        else if (i == e_obj)   self.inserta("e");
!        else if (i == w_obj)   self.inserta("w");
!        else if (i == u_obj)   self.inserta("sube");
!        else if (i == d_obj)   self.inserta("baja");
!        else if (i == in_obj)  self.inserta("entra");
!        else if (i == se_obj)  self.inserta("se");
!        else if (i == sw_obj)  self.inserta("sw");
!        else if (i == ne_obj)  self.inserta("ne");
!        else if (i == nw_obj)  self.inserta("nw");
!        else if (i == out_obj) self.inserta("salir");
!        ! NO QUEREMOS que el jugador se mueva como un PNJ y lo paramos...
!        PNJ_Ruta(actor, MOVIMIENTO_NINGUNO); 
!      }
!    ];

! Modificamos KeyboardPrimitive para que tenga en cuenta la variable global
! parse_input_externo y actúe en consecuencia:
[ KeyboardPrimitive  a_buffer a_table done ix;

  ! Comienzo del hackeo (c) Alpha
  if (parse_input_externo > 0) {
    if (test_machine.get_input() ~= 0) {
      if (parse_input_externo == 2) parse_input_externo = -1; ! Para gtalk
      Tokenise__(buffer, parse);
      rfalse;
    }
  }
  if (parse_input_externo == -1) parse_input_externo = 0;
  ! Fin del hackeo (c) Alpha

  if (gg_commandstr ~= 0 && gg_command_reading ~= false) {
    ! get_line_stream
    done = glk($0091, gg_commandstr, a_buffer + WORDSIZE,
               (INPUT_BUFFER_LEN - WORDSIZE) - 1);
    if (done == 0) {
      glk($0044, gg_commandstr, 0); ! stream_close
      gg_commandstr = 0;
      gg_command_reading = false;
      ! L__M(##CommandsRead, 5); would come after prompt
      ! fall through to normal user input.
    } else {
      ! Trim the trailing newline
      if ((a_buffer + WORDSIZE)->(done - 1) == 10) done = done - 1;
      a_buffer-->0 = done;
      glk($0086, 8); ! set input style
      glk($0084, a_buffer + WORDSIZE, done); ! put_buffer
      glk($0086, 0); ! set normal style
      print "^";
      jump KPContinue;
    }
  }
  done = false;
  glk($00D0, gg_mainwin, a_buffer + WORDSIZE,
      INPUT_BUFFER_LEN - WORDSIZE, 0); ! request_line_event
  while (~~done) {
    glk($00C0, gg_event); ! select
    switch (gg_event-->0) {
      5: ! evtype_Arrange
         DrawStatusLine();
      3: ! evtype_LineInput
         if (gg_event-->1 == gg_mainwin) {
           a_buffer-->0 = gg_event-->2;
           done = true;
         }
    }
    ix = HandleGlkEvent(gg_event, 0, a_buffer);
    if (ix == 2) done = true;
    else if (ix == -1) done = false;
  }
  if (gg_commandstr ~= 0 && gg_command_reading == false) {
    ! put_buffer_stream
    glk($0085, gg_commandstr, a_buffer + WORDSIZE, a_buffer-->0);
    glk($0081, gg_commandstr, 10); ! put_char_stream (newline)
  }
.KPContinue;
  Tokenise__(a_buffer, a_table);
  ! It's time to close any quote window we've got going.
  if (gg_quotewin) {
    glk($0024, gg_quotewin, 0); ! close_window
    gg_quotewin = 0;
  }
];

